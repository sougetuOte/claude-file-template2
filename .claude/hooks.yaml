# Claude Code Hooks Configuration
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è‡ªå‹•åŒ–ã‚’å®šç¾©ã—ã¾ã™

hooks:
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: å±é™ºãªã‚³ãƒžãƒ³ãƒ‰ã®äº‹å‰ãƒã‚§ãƒƒã‚¯
  - event: PreToolUse
    matcher:
      tool: Bash
    command: |
      # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ã«ã‚ˆã‚‹äº‹å‰ãƒã‚§ãƒƒã‚¯
      echo "ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..." >&2
      python3 .claude/scripts/bash_security_validator.py

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–: é«˜ãƒªã‚¹ã‚¯ã‚³ãƒžãƒ³ãƒ‰ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
  - event: PreToolUse
    matcher:
      tool: Bash
    command: |
      if echo "$CLAUDE_COMMAND" | grep -E "(rm -rf|sudo|curl.*-X|wget.*-O)" >/dev/null 2>&1; then
        echo "âš ï¸  é«˜ãƒªã‚¹ã‚¯ã‚³ãƒžãƒ³ãƒ‰æ¤œå‡º: $CLAUDE_COMMAND" >&2
        echo "$(date '+%Y-%m-%d %H:%M:%S') [HIGH-RISK] $CLAUDE_COMMAND" >> .claude/logs/security.log
        # 5ç§’å¾…æ©Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯èƒ½ï¼‰
        sleep 5 || true
      fi

  # ã‚³ãƒŸãƒƒãƒˆå‰è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
  - event: PreToolUse
    matcher:
      tool: Bash
      command_contains: "git commit"
    command: |
      if command -v prettier >/dev/null 2>&1 && [ -f .prettierrc ]; then
        echo "âœ¨ ã‚³ãƒŸãƒƒãƒˆå‰è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå®Ÿè¡Œä¸­..."
        # ã‚¹ãƒ†ãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ
        git diff --cached --name-only --diff-filter=ACM | xargs prettier --write 2>/dev/null || true
        # ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆå¾Œã«å†ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
        git add -u 2>/dev/null || true
      fi

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚³ãƒžãƒ³ãƒ‰å®Ÿè¡Œãƒ­ã‚°ã®è¨˜éŒ²
  - event: PostToolUse
    matcher:
      tool: Bash
    command: |
      # ã‚³ãƒžãƒ³ãƒ‰å®Ÿè¡Œãƒ­ã‚°ã‚’è¨˜éŒ²
      LOG_FILE=".claude/logs/command_history.log"
      mkdir -p "$(dirname "$LOG_FILE")"
      TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
      echo "[$TIMESTAMP] [$CLAUDE_EXIT_CODE] $CLAUDE_COMMAND" >> "$LOG_FILE"
      
      # å±é™ºãªã‚³ãƒžãƒ³ãƒ‰ã®å®Ÿè¡Œã‚’ç‰¹åˆ¥ã«ãƒ­ã‚°è¨˜éŒ²
      if echo "$CLAUDE_COMMAND" | grep -E "(sudo|rm|chmod|curl|wget|git config --global)" >/dev/null 2>&1; then
        echo "[$TIMESTAMP] [SECURITY-ALERT] Potentially dangerous command executed: $CLAUDE_COMMAND" >> .claude/logs/security.log
      fi

  # ã‚³ãƒ¼ãƒ‰å“è³ªã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
  - event: PostToolUse
    matcher:
      tool: [Edit, Write, MultiEdit]
      glob: "*.{js,ts,jsx,tsx,py}"
    command: |
      # ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆå¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–ï¼‰
      # echo "[$(date '+%Y-%m-%d %H:%M')] ã‚³ãƒ¼ãƒ‰å¤‰æ›´: $CLAUDE_FILE_PATHS" >> .claude/logs/changes.log
      # è¨€èªžåˆ¥ã®å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã™ã‚‹ã‚³ãƒžãƒ³ãƒ‰ã®ã¿å®Ÿè¡Œï¼‰
      if command -v npm >/dev/null 2>&1 && [ -f package.json ]; then
        npm run lint --if-present
        npm run typecheck --if-present
      elif command -v python >/dev/null 2>&1 && [ -f requirements.txt ]; then
        python -m flake8 $CLAUDE_FILE_PATHS 2>/dev/null || true
        python -m mypy $CLAUDE_FILE_PATHS 2>/dev/null || true
      fi

  # ä¾å­˜é–¢ä¿‚è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆè»½é‡ç‰ˆï¼‰
  - event: PostToolUse
    matcher:
      tool: [Edit, Write]
      glob: "package.json"
    command: |
      if command -v npm >/dev/null 2>&1; then
        echo "ðŸ“¦ package.jsonæ›´æ–°ã‚’æ¤œå‡º"
        # è»½é‡ãƒã‚§ãƒƒã‚¯ï¼šä¾å­˜é–¢ä¿‚ã®æ§‹æ–‡ç¢ºèªã®ã¿
        npm ls --depth=0 --silent 2>/dev/null || echo "âš ï¸  ä¾å­˜é–¢ä¿‚ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
      fi

  # ãƒ†ã‚¹ãƒˆæˆåŠŸæ™‚ã®è‡ªå‹•è¨˜éŒ²
  - event: PostToolUse
    matcher:
      tool: Bash
      command_contains: "test"
    command: |14
      if [ $CLAUDE_EXIT_CODE -eq 0 ]; then
        echo "### $(date '+%Y-%m-%d %H:%M') - ãƒ†ã‚¹ãƒˆæˆåŠŸ" >> .claude/context/history.md
        echo "- ã‚³ãƒžãƒ³ãƒ‰: $CLAUDE_COMMAND" >> .claude/context/history.md
        echo "" >> .claude/context/history.md
      fi

  # æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã®è¨˜éŒ²
  - event: PostToolUse
    matcher:
      tool: [Write, MultiEdit]
      glob: "*.{js,ts,jsx,tsx,py}"
    command: |
      # æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚ŒãŸå ´åˆ
      if [ "$CLAUDE_TOOL" = "Write" ]; then
        # æ–°æ©Ÿèƒ½è¿½åŠ ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆå¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–ï¼‰
        # echo "### $(date '+%Y-%m-%d') - æ–°æ©Ÿèƒ½è¿½åŠ : $CLAUDE_FILE_PATHS" >> .claude/logs/features.log
      fi

  # gitæ“ä½œã®è‡ªå‹•è¨˜éŒ²
  - event: PostToolUse
    matcher:
      tool: Bash
      command_contains: "git commit"
    command: |
      if [ $CLAUDE_EXIT_CODE -eq 0 ]; then
        # ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ­ã‚°ã«è¨˜éŒ²ï¼ˆå¿…è¦ã«å¿œã˜ã¦æœ‰åŠ¹åŒ–ï¼‰
        # echo "### $(date '+%Y-%m-%d %H:%M') - ã‚³ãƒŸãƒƒãƒˆ" >> .claude/logs/commits.log
        # echo "$CLAUDE_OUTPUT" >> .claude/logs/commits.log
      fi

  # Memory Bank 2.0: MarkdownåŒæœŸ
  - event: PostToolUse
    matcher:
      tool: [Edit, Write, MultiEdit]
      glob: ".claude/**/*.md"
    command: |
      # Markdownãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«çŸ¥è­˜DBã¨åŒæœŸ
      if command -v python3 >/dev/null 2>&1; then
        echo "ðŸ“ Memory BankåŒæœŸä¸­..."
        python3 .claude/index/sync_markdown.py
      fi

  # Phase 3: AIç”Ÿæˆã‚³ãƒ¼ãƒ‰å“è³ªãƒ¢ãƒ‹ã‚¿ãƒ¼
  - event: PostToolUse
    matcher:
      tool: [Write, Edit]
      glob: "*.py"
    command: |
      # Pythonãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if command -v python3 >/dev/null 2>&1 && [ -f .claude/quality/code_monitor.py ]; then
        echo "ðŸ” ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ä¸­..."
        python3 .claude/quality/code_monitor.py check "$CLAUDE_FILE_PATHS" || true
      fi

  # Phase 3: çŸ¥è­˜è‡ªå‹•æ•´ç†ï¼ˆé€±1å›žï¼‰
  - event: SessionStart
    command: |
      # æœ€å¾Œã®æ•´ç†ã‹ã‚‰7æ—¥çµŒéŽã—ã¦ã„ãŸã‚‰å®Ÿè¡Œ
      if [ ! -f .claude/index/.last_organize ] || \
         [ $(find .claude/index/.last_organize -mtime +7 2>/dev/null | wc -l) -gt 0 ]; then
        if command -v python3 >/dev/null 2>&1 && [ -f .claude/index/auto_organize.py ]; then
          echo "ðŸ—‚ï¸  çŸ¥è­˜ãƒ™ãƒ¼ã‚¹æ•´ç†ä¸­..."
          python3 .claude/index/auto_organize.py organize >/dev/null 2>&1 || true
          touch .claude/index/.last_organize
        fi
      fi

  # ãƒãƒƒãƒå‡¦ç†ï¼ˆMultiEditæ™‚ã®åŠ¹çŽ‡åŒ–ï¼‰
  - event: PostToolUse
    matcher:
      tool: [MultiEdit]
    command: |
      echo "ðŸ”„ MultiEditå¾Œãƒãƒƒãƒå‡¦ç†å®Ÿè¡Œä¸­..."
      # é †æ¬¡å®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ã‚’å€‹åˆ¥ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      if command -v npm >/dev/null 2>&1 && [ -f package.json ]; then
        npm run lint --if-present --silent 2>/dev/null || echo "lint: è­¦å‘Šã‚ã‚Š"
        npm run typecheck --if-present --silent 2>/dev/null || echo "typecheck: è­¦å‘Šã‚ã‚Š"
      fi
      if command -v python3 >/dev/null 2>&1 && [ -f .claude/quality/code_monitor.py ]; then
        python3 .claude/quality/code_monitor.py check "$CLAUDE_FILE_PATHS" 2>/dev/null || echo "code_monitor: è­¦å‘Šã‚ã‚Š"
      fi

  # Phase 3: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆè»½é‡ç‰ˆï¼‰
  - event: PostToolUse
    matcher:
      tool: [Write, Edit]
      glob: "*.{js,ts,jsx,tsx}"
    command: |
      # JavaScript/TypeScriptãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ™‚ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
      if command -v python3 >/dev/null 2>&1 && [ -f .claude/quality/code_monitor.py ]; then
        python3 .claude/quality/code_monitor.py check "$CLAUDE_FILE_PATHS" | grep -E "(duplicate_found|suggestions)" || true
      fi

# ç’°å¢ƒå¤‰æ•°è¨­å®š
env:
  CLAUDE_HOOKS_ENABLED: true
  CLAUDE_PROJECT_ROOT: $PWD
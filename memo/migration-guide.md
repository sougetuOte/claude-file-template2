# 既存プロジェクトへの段階的マイグレーション ガイド

既に運用中のプロジェクトに、前世代メモリバンクシステムから新機能を段階的に導入するための実践ガイドです。

## 🎯 導入可能テクニック一覧

### 🟢 即座導入可能（リスク：極低）
1. **プロンプトキャッシュ最適化**
2. **.gitignore強化**
3. **誤字・一貫性修正**

### 🟡 段階導入推奨（リスク：低）
4. **ADRシステム**
5. **技術負債トラッキング**
6. **セキュリティ強化**

### 🔴 慎重検討必要（リスク：中）
7. **Memory Bank構造変更**

---

## 🚀 段階1: 即座導入可能（所要時間：15分）

### 1.1 プロンプトキャッシュ最適化

#### 思想
- **90%コスト削減・85%レイテンシ短縮**の恩恵を既存プロジェクトでも享受
- 既存ワークフローに**一切影響なし**
- 長期安定な情報（概要、技術スタック等）の再利用効率化

#### 導入手順

**Step 1: 環境設定ファイル作成**
```bash
# プロジェクトルートで実行
touch .claude/settings.json
```

**Step 2: キャッシュ設定追加**
```json
// .claude/settings.json
{
  "env": {
    "CLAUDE_CACHE": "./.ccache"
  }
}
```

**Step 3: cache_control適用**
以下のファイルに `cache_control` を追加（存在する場合のみ）：

```yaml
---
cache_control: {"type": "ephemeral"}
---
```

**適用対象ファイル**：
- プロジェクト概要系（overview.md、README系）
- 技術仕様系（tech.md、requirements.md）
- テンプレート・パターン集

**Step 4: .gitignore更新**
```gitignore
# Claude Code キャッシュファイル
.ccache/
*.cache
```

#### 期待効果
- **即座**: 同一プロンプト再実行で大幅コスト削減
- **累積**: 長期運用でのトークン使用量最適化

### 1.2 .gitignore強化

#### 思想
- キャッシュファイルの適切な除外
- 開発環境の整理・統一

#### 導入手順
既存の`.gitignore`に以下を追加：

```gitignore
# Claude Code 関連
.ccache/
*.cache

# 共通除外パターン（必要に応じて）
.DS_Store
*.swp
*.tmp
.env
.vscode/settings.json
```

### 1.3 誤字・一貫性修正

#### 思想
- 文書品質の向上
- チーム内コミュニケーションの改善

#### 導入手順
以下の用語を統一：
- 「連用」→「運用」
- 「遵用」→「運用」
- カスタムコマンド説明の詳細度統一

---

## 📈 段階2: 段階導入推奨（所要時間：30分）

### 2.1 ADRシステム導入

#### 思想
- **技術的意思決定の透明化**
- 将来の変更・保守での「なぜその技術を選んだか」の明確化
- チーム知識の蓄積・継承

#### 導入手順

**Step 1: ディレクトリ作成**
```bash
mkdir -p docs/adr
```

**Step 2: テンプレート配置**
[ADRテンプレート内容をコピー - docs/adr/template.md]

**Step 3: 既存決定の遡及記録**
```bash
# 過去の重要決定を1つずつ記録
cp docs/adr/template.md docs/adr/0001-initial-tech-stack.md
# 内容を過去の決定に合わせて編集
```

#### 推奨運用
- **新規技術導入時**: 必ずADR作成
- **アーキテクチャ変更時**: 背景・理由を明文化
- **月1回**: ADRレビューで決定の妥当性確認

#### 期待効果
- **即時**: 技術選択の根拠明確化
- **長期**: 技術負債化の予防

### 2.2 技術負債トラッキング

#### 思想
- **見える化による負債管理**
- 優先度付けによる効率的解決
- キャッシュ影響を考慮したコスト管理

#### 導入手順

**Step 1: 負債ログファイル作成**
```bash
touch .claude/context/debt.md
```

**Step 2: 既存負債の棚卸し**
```markdown
# 現在認識している技術負債をリストアップ
### 高優先度 🔥
| 負債内容 | 推定コスト | 期限 | 影響範囲 |
|---------|-----------|------|---------|
| 古いライブラリ依存 | 4時間 | 来月末 | 全体 |
```

**Step 3: 運用ルール策定**
- **新機能開発時**: 発生可能性のある負債を事前記録
- **スプリント終了時**: 実際に発生した負債の優先度付け
- **月1回**: 負債全体の見直し

#### 期待効果
- **即時**: 負債の可視化・優先度明確化
- **中期**: 計画的な負債解決
- **長期**: 負債発生の予防

### 2.3 セキュリティ強化

#### 思想
- **Claude Code安全性向上**: `--dangerously-skip-permissions`使用時の安全性確保
- **危険コマンドの自動ブロック**: 破壊的操作の事前防止
- **セキュリティログ**: 全コマンドの実行記録・監査

#### 導入手順

**Step 1: settings.jsonへのセキュリティ設定追加**
```json
// .claude/settings.json に追加
{
  "permissions": {
    "deny": [
      "Bash(sudo *)",
      "Bash(rm -rf /*)",
      "Bash(chmod 777 *)",
      "Bash(curl *)",
      "Bash(wget *)"
    ]
  }
}
```

**Step 2: セキュリティスクリプトの配置**
```bash
# scriptsディレクトリ作成
mkdir -p .claude/scripts

# セキュリティバリデーター（テンプレートから）
cp [template]/claude/scripts/bash_security_validator.py .claude/scripts/
cp [template]/claude/scripts/deny-check.sh .claude/scripts/
cp [template]/claude/scripts/test_security.py .claude/scripts/

# 実行権限付与
chmod +x .claude/scripts/*.py
chmod +x .claude/scripts/*.sh
```

**Step 3: hooksへのセキュリティ統合**
```yaml
# .claude/hooks.yaml に追加
hooks:
  - event: PreToolUse
    matcher:
      tool: Bash
    command: |
      echo "🔒 セキュリティチェック実行中..." >&2
      python3 .claude/scripts/bash_security_validator.py
```

**Step 4: 動作確認**
```bash
# セキュリティテストの実行
python3 .claude/scripts/test_security.py

# 期待結果: 全テストが通過
```

#### 推奨運用
- **定期テスト**: 月1回のセキュリティテスト実行
- **ログ監視**: 週1回のセキュリティログ確認
- **ルール調整**: プロジェクトに応じた危険コマンドパターンの調整

#### 期待効果
- **即時**: 危険コマンドの自動ブロック
- **短期**: セキュリティインシデントの予防
- **長期**: 安全なClaude Code利用習慣の定着

---

## ⚠️ 段階3: 慎重検討必要（所要時間：1-2時間）

### 3.1 Memory Bank構造変更

#### 思想
- **階層化による効率化**
- **コンテキスト使用量の最小化**

#### 注意点
- 既存ワークフローへの影響大
- チーム全体での合意必要
- 段階的移行推奨

#### 導入判断基準
以下の条件が揃った場合のみ実施：
- [ ] チーム全体での合意取得済み
- [ ] 現在のシステムでの不便を実感
- [ ] 移行期間（1-2週間）の確保可能
- [ ] ロールバック手順の準備完了

#### 導入手順（合意後）
```bash
# 既存ファイルのバックアップ
cp -r .claude .claude.backup

# 新構造ディレクトリ作成
mkdir -p .claude/context
mkdir -p .claude/debug  
mkdir -p .claude/commands

# 段階的移行
# 1週間ごとに1つずつ移動
```

---

## 📋 導入チェックリスト

### Phase 1（即座導入）
- [ ] .claude/settings.json作成
- [ ] cache_control適用（対象ファイル特定・追加）
- [ ] .gitignore更新
- [ ] 用語統一（誤字修正）
- [ ] キャッシュ効果確認（コスト削減実感）

### Phase 2（段階導入）
- [ ] ADRディレクトリ・テンプレート作成
- [ ] 過去の技術決定1-2件をADR化
- [ ] 負債ログファイル作成
- [ ] 既存負債の棚卸し完了
- [ ] 運用ルール設定・チーム共有
- [ ] セキュリティ設定追加（settings.json）
- [ ] セキュリティスクリプト配置・権限設定
- [ ] hooksにセキュリティ統合
- [ ] セキュリティテスト実行・確認

### Phase 3（慎重検討）
- [ ] チーム合意取得
- [ ] 移行計画策定
- [ ] バックアップ取得
- [ ] 段階的移行実施

---

## 🎯 成功パターン事例

### ケース1: 小規模個人プロジェクト
**適用**: Phase 1 + ADRシステム
**結果**: 30%のコスト削減、技術選択の記録化
**期間**: 1日

### ケース2: 中規模チームプロジェクト  
**適用**: Phase 1 + Phase 2 完全実施
**結果**: 50%のコスト削減、負債の計画的解決
**期間**: 2週間（段階的導入）

### ケース3: 大規模プロジェクト
**適用**: Phase 1のみ
**結果**: 安全確実なコスト削減のみ実現
**期間**: 半日

---

## ⚡ トラブルシューティング

### よくある問題

**Q: cache_controlを追加後、エラーが発生**
A: YAMLフロントマターの形式確認。既存内容との衝突チェック

**Q: キャッシュ効果が実感できない**  
A: 同一プロンプトの再実行確認。cache_control対象ファイルの使用頻度確認

**Q: ADRが続かない**
A: 最初は重要決定のみ。完璧を求めず継続重視

**Q: 負債ログが形骸化**
A: 月1回のレビュー必須。優先度の見直し定期実施

---

## 📊 効果測定指標

### 定量指標
- **コスト削減率**: キャッシュヒット時の課金比較
- **レスポンス短縮**: 同一プロンプト実行時間比較  
- **負債解決率**: 月次での負債完了件数

### 定性指標
- **技術選択の透明性**: ADR活用による意思決定品質
- **チーム知識共有**: 新メンバーのオンボーディング速度
- **開発効率**: 負債起因の作業中断回数

この段階的導入により、既存プロジェクトでも新テンプレートの恩恵を安全確実に享受できます。